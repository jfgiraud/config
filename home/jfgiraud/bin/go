#!/bin/bash

__file="$1"
shift

function get_choice_param() {
    local account="${1//\//\\/}"
    awk $"BEGIN { RS=\"\n\n\" } /(^|\n)account ${account}(\n|$)/ { print }" $__file | sed -e 's/^[[:space:]]*$//;/^$/d' | sed -e 's/ /="/' -e 's/$/"/'
}

function select_choice () {
    local account="$1"
    eval $(get_choice_param "$account")
    if [ "$type" == "mysql" ]; then
	mysql -P"$port" -h "$host" -u "$login" -p"$password" "$name"
    elif [ "$type" == "ssh" ]; then
	ssh -X "$login@$host"
    else
	echo "Type '$type' not supported!"
    fi
}

function get_credentials () {
    local patterns="account $*"
    local choices=()
    while IFS=$'\n' read line || [[ $line ]]; 
    do
	local matches=1
	for pattern in $patterns; do
	    if [[ ! "$line" =~ $pattern ]]; then
		matches=0
		break
	    fi
	done
	if [ $matches -eq 1 ]; then
	    choices+=("${line#account }")
	fi
    done < <( grep -E '^account ' $__file | sort)

    if [ ${#choices[@]} -eq 1 ]; then
	select_choice "${choices[0]}"
	return
    fi

    select choice in "${choices[@]}";
    do
	select_choice "$choice"
	break
    done
	
}

get_credentials $*
