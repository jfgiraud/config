#!/bin/bash

command="$1"
shift

function parse() {
    local command="$1"
    tempf=$(mktemp)
    $command --help 2>&1 | sed -e 's/^[[:space:]]\{16,\}.*//' -e 's/^[[:space:]]*//' | grep -E '^-' | sed -e 's/[[:space:]]\{2,\}.*//' > $tempf
    local longopts=""
    local shortopts=""
    while read line || [[ $line ]];
    do
	required=""
        if grep -Fq '[=' <<< "$line"; then
            required="::"
	elif grep -Fq '=' <<< "$line"; then
	    required=":"
	fi
	while read option || [[ $option ]];
	do
            option=${option%%=*}
            option=${option%[}
	    if [ ${option:0:2} == '--' ]; then
		if [ -n "$longopts" ]; then
		    longopts="${longopts},"
		fi
		longopts="${longopts}${option:2}${required}"
            else
		shortopts="${shortopts}${option:1}${required}"
	    fi
        done < <(echo $line | tr ',' '\n' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]\+.*//')
    done < $tempf
    rm -f $tempf
    echo "-o '$shortopts' -l '$longopts'"
}

getopt $(parse $command) -- "$@"

exit 1



usage() {
	cat <<-EOF
NAME

        ${0##*/} - change file timestamps

DESCRIPTION

       Update the access and modification times of each FILE to the current time.

       A FILE argument that does not exist is created empty. The parent directories containing the file are also created if needed.

AUTHOR

       Written by Jean-François Giraud.

COPYRIGHT

       Copyright © 2014 Jean-François Giraud.  License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.
       This is free software: you are free to change and redistribute it.  There is NO WARRANTY, to the extent permitted by law.

EOF
	exit 0
}


error() {
    STATUS="$1"
    MSG="$2"
    cat >&2 <<-EOF
${0##*/}: $MSG
Try \`${0##*/} -h\` for more information.
EOF
    exit 1
}

if [ $# -eq 0 ]; then
    error 1 "Missing parameters!" 
fi

if [[ $# -eq 1 && "$1" == "-h" ]]; then
    usage
fi

for file in $*; do
    dn=${file%/*}
    fn=${file##*/}
    mkdir -p $dn && touch $dn/$fn
done 
